//@version=5
strategy("Intraday Breakout Buy/Sell (Filtered, Fewer Trades)", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// === Inputs ===
breakout_length = input.int(30, title="Breakout Lookback Period") // Increased for fewer signals
atr_length = input.int(14, title="ATR Period")
atr_mult = input.float(1.0, title="ATR Multiplier for Stop Loss")
take_profit_mult = input.float(1.5, title="Take Profit Multiplier (x ATR)")
vol_filter = input.bool(true, title="Enable Volume Filter")
vol_mult = input.float(1.2, title="Volume Multiplier (x average)")
vol_length = input.int(20, title="Volume Lookback Period")
session_start_hour = input.int(9, title="Session Start Hour (Exchange Time)")
session_start_min = input.int(30, title="Session Start Minute")
session_end_hour = input.int(16, title="Session End Hour (Exchange Time)")
session_end_min = input.int(0, title="Session End Minute")
rsi_length = input.int(14, title="RSI Length")
rsi_long = input.int(55, title="RSI Min for Long")
rsi_short = input.int(45, title="RSI Max for Short")
min_body_mult = input.float(0.3, title="Min Candle Body Multiplier (x ATR)")

// === Session Filter ===
session_open = (hour >= session_start_hour and (hour > session_start_hour or minute >= session_start_min))
session_close = (hour < session_end_hour or (hour == session_end_hour and minute <= session_end_min))
in_session = session_open and session_close

// === Breakout Levels ===
highest_high = ta.highest(high, breakout_length)
lowest_low = ta.lowest(low, breakout_length)

// === ATR & Volume Filters ===
atr = ta.atr(atr_length)
avg_vol = ta.sma(volume, vol_length)
vol_ok = not vol_filter or (volume > avg_vol * vol_mult)

// === RSI Filter ===
rsi = ta.rsi(close, rsi_length)

// === Confirmation Candle ===
body_size = math.abs(close - open)
strong_bull = close > open and close > highest_high[1] and body_size > atr * min_body_mult and rsi > rsi_long
strong_bear = close < open and close < lowest_low[1] and body_size > atr * min_body_mult and rsi < rsi_short

// === One Trade Per Direction Per Day ===
var float last_long_trade_day = na
var float last_short_trade_day = na
today = dayofyear

can_long = na(last_long_trade_day) or last_long_trade_day != today
can_short = na(last_short_trade_day) or last_short_trade_day != today

// === Entry Logic ===
long_entry = in_session and strong_bull and vol_ok and can_long
short_entry = in_session and strong_bear and vol_ok and can_short

// === Stop Loss and Take Profit ===
long_stop = close - atr * atr_mult
long_tp = close + atr * take_profit_mult
short_stop = close + atr * atr_mult
short_tp = close - atr * take_profit_mult

// === Execute Trades ===
if (long_entry)
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", "Long", stop=long_stop, limit=long_tp)
    last_long_trade_day := today

if (short_entry)
    strategy.entry("Short", strategy.short)
    strategy.exit("Short Exit", "Short", stop=short_stop, limit=short_tp)
    last_short_trade_day := today

// === Plot Breakout Levels ===
plot(highest_high, color=color.green, linewidth=1, title="Breakout High")
plot(lowest_low, color=color.red, linewidth=1, title="Breakout Low")
